<!-- templates/common/signup_with_verification.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}회원가입 - 테크창{% endblock %}

{% block head_extra %}
  {{ block.super }}
  {% csrf_token %}
  <script>
    // CSRF 토큰 전역 변수에 저장
    window.CSRF_TOKEN = "{{ csrf_token }}";
  </script>
{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-lg-6">
      <div class="card shadow border-0" style="border-radius: 15px;">
        <div class="card-header bg-primary text-white text-center py-4" style="border-radius: 15px 15px 0 0;">
          <i class="fas fa-user-plus fa-3x mb-3"></i>
          <h2 class="mb-1">회원가입</h2>
          <p class="mb-0">테크창 커뮤니티에 오신 것을 환영합니다</p>
        </div>
        <div class="card-body p-4">
          {% if messages %}
            {% for message in messages %}
              <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              </div>
            {% endfor %}
          {% endif %}
          <form method="post" id="signupForm" action="{% url 'common:signup' %}">
            {% csrf_token %}
            <!-- 사용자명 -->
            <div class="mb-3">
              <label for="{{ form.username.id_for_label }}" class="form-label fw-semibold">
                <i class="fas fa-user me-2 text-primary"></i>사용자명 <span class="text-danger">*</span>
              </label>
              {{ form.username }}
              {% if form.username.errors %}
                <div class="text-danger small mt-1">{{ form.username.errors }}</div>
              {% endif %}
            </div>

            <!-- 이메일 입력 및 인증코드 발송 -->
            <div class="mb-3">
              <label for="{{ form.email.id_for_label }}" class="form-label fw-semibold">
                <i class="fas fa-envelope me-2 text-primary"></i>이메일 <span class="text-danger">*</span>
              </label>
              <div class="input-group">
                {{ form.email }}
                <button type="button" class="btn btn-outline-primary" id="sendCodeBtn">
                  <i class="fas fa-paper-plane me-1"></i>인증코드 발송
                </button>
              </div>
              {% if form.email.errors %}
                <div class="text-danger small mt-1">{{ form.email.errors }}</div>
              {% endif %}
              <div class="form-text">이메일로 인증 코드를 받아 확인해주세요.</div>
            </div>

            <!-- 인증코드 입력란 -->
            <div class="mb-3" id="codeSection" style="display:none;">
              <label class="form-label fw-semibold">
                <i class="fas fa-key me-2 text-success"></i>이메일 인증 코드 <span class="text-danger">*</span>
              </label>
              <div class="input-group">
                <input type="text" class="form-control" id="verificationCode"
                       placeholder="4자리 숫자 입력" maxlength="4" pattern="\d{4}">
                <button type="button" class="btn btn-outline-success" id="verifyCodeBtn">
                  <i class="fas fa-check me-1"></i>인증 확인
                </button>
              </div>
              <div class="form-text">이메일로 받은 4자리 인증 코드를 입력하세요.</div>
              <div id="verificationStatus"></div>
            </div>

            <!-- 닉네임 -->
            <div class="mb-3">
              <label for="{{ form.nickname.id_for_label }}" class="form-label fw-semibold">
                <i class="fas fa-id-badge me-2 text-primary"></i>닉네임 <span class="text-muted">(선택사항)</span>
              </label>
              {{ form.nickname }}
              {% if form.nickname.errors %}
                <div class="text-danger small mt-1">{{ form.nickname.errors }}</div>
              {% endif %}
              <div class="form-text">닉네임을 설정하지 않으면 사용자명이 표시됩니다.</div>
            </div>

            <!-- 비밀번호 -->
            <div class="mb-3">
              <label for="{{ form.password1.id_for_label }}" class="form-label fw-semibold">
                <i class="fas fa-lock me-2 text-primary"></i>비밀번호 <span class="text-danger">*</span>
              </label>
              {{ form.password1 }}
              {% if form.password1.errors %}
                <div class="text-danger small mt-1">{{ form.password1.errors }}</div>
              {% endif %}
            </div>

            <!-- 비밀번호 확인 -->
            <div class="mb-4">
              <label for="{{ form.password2.id_for_label }}" class="form-label fw-semibold">
                <i class="fas fa-lock me-2 text-primary"></i>비밀번호 확인 <span class="text-danger">*</span>
              </label>
              {{ form.password2 }}
              {% if form.password2.errors %}
                <div class="text-danger small mt-1">{{ form.password2.errors }}</div>
              {% endif %}
            </div>

            <!-- 회원가입 버튼 -->
            <div class="d-flex justify-content-between align-items-center">
              <a href="{% url 'common:login' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>로그인으로 돌아가기
              </a>
              <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" disabled>
                <i class="fas fa-user-plus me-1"></i>회원가입 완료
              </button>
            </div>
          </form>
        </div>
      </div>
      <div class="text-center mt-4">
        <p class="text-muted small">
          <i class="fas fa-shield-alt me-1"></i>
          테크창은 안전한 이메일 인증을 통해 계정을 보호합니다
        </p>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const emailInput      = document.querySelector('input[name="email"]');
  const sendCodeBtn     = document.getElementById('sendCodeBtn');
  const codeSection     = document.getElementById('codeSection');
  const verificationCode= document.getElementById('verificationCode');
  const verifyCodeBtn   = document.getElementById('verifyCodeBtn');
  const verificationStatus = document.getElementById('verificationStatus');
  const submitBtn       = document.getElementById('submitBtn');

  function getCSRF() {
    return window.CSRF_TOKEN ||
      document.cookie.replace(/(?:(?:^|.*;\s*)csrftoken\s*\=\s*([^;]*).*$)|^.*$/, "$1");
  }

  sendCodeBtn.addEventListener('click', () => {
    const email = emailInput.value.trim();
    if (!email) {
      alert('이메일을 입력해주세요.');
      return;
    }
    sendCodeBtn.disabled = true;
    fetch("{% url 'common:send_verification_email' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRF()
      },
      body: JSON.stringify({ email })
    })
    .then(r => r.json())
    .then(data => {
      alert(data.message);
      if (data.success) {
        codeSection.style.display = 'block';
      } else {
        sendCodeBtn.disabled = false;
      }
    })
    .catch(() => {
      alert('서버 오류가 발생했습니다.');
      sendCodeBtn.disabled = false;
    });
  });

  verifyCodeBtn.addEventListener('click', () => {
    const email = emailInput.value.trim();
    const code  = verificationCode.value.trim();
    if (!email || !code) {
      alert('이메일과 인증 코드를 모두 입력해주세요.');
      return;
    }
    verifyCodeBtn.disabled = true;
    fetch("{% url 'common:verify_email_code' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRF()
      },
      body: JSON.stringify({ email, code })
    })
    .then(r => r.json())
    .then(data => {
      verificationStatus.textContent = data.message;
      if (data.success) {
        submitBtn.disabled = false;
        verifyCodeBtn.disabled = true;
      } else {
        verifyCodeBtn.disabled = false;
      }
    })
    .catch(() => {
      alert('서버 오류가 발생했습니다.');
      verifyCodeBtn.disabled = false;
    });
  });
});
</script>
{% endblock %}
