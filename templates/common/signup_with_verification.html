{% extends 'base.html' %}
{% load static %}

{% block title %}회원가입 - 테크창{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-lg-6">
      <div class="card shadow border-0" style="border-radius: 15px;">
        <div class="card-header bg-primary text-white text-center py-4" style="border-radius: 15px 15px 0 0;">
          <i class="fas fa-user-plus fa-3x mb-3"></i>
          <h2 class="mb-1">회원가입</h2>
          <p class="mb-0">테크창 커뮤니티에 오신 것을 환영합니다</p>
        </div>
        <div class="card-body p-4">
          {% if messages %}
            {% for message in messages %}
              <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              </div>
            {% endfor %}
          {% endif %}
          <form id="signupForm" method="post" action="{% url 'common:signup' %}">
            {% csrf_token %}
            <div class="mb-3">
              <label for="{{ form.username.id_for_label }}" class="form-label fw-semibold">
                <i class="fas fa-user me-2 text-primary"></i>사용자명 <span class="text-danger">*</span>
              </label>
              {{ form.username }}
            </div>
            <div class="mb-3">
              <label for="{{ form.email.id_for_label }}" class="form-label fw-semibold">
                <i class="fas fa-envelope me-2 text-primary"></i>이메일 <span class="text-danger">*</span>
              </label>
              <div class="input-group">
                {{ form.email }}
                <button type="button" class="btn btn-outline-primary" id="sendCodeBtn">
                  <i class="fas fa-paper-plane me-1"></i>인증코드 발송
                </button>
              </div>
              <div class="form-text">이메일로 인증 코드를 받아 확인해주세요.</div>
            </div>
            <div class="mb-3" id="codeSection" style="display:none;">
              <label class="form-label fw-semibold">
                <i class="fas fa-key me-2 text-success"></i>이메일 인증 코드 <span class="text-danger">*</span>
              </label>
              <div class="input-group">
                <input type="text" class="form-control" id="verificationCode" placeholder="4자리 숫자 입력" maxlength="4">
                <button type="button" class="btn btn-outline-success" id="verifyCodeBtn">
                  <i class="fas fa-check me-1"></i>인증 확인
                </button>
              </div>
              <div id="verificationStatus" class="mt-2"></div>
            </div>
            {{ form.nickname.label_tag }} {{ form.nickname }}
            {{ form.password1.label_tag }} {{ form.password1 }}
            {{ form.password2.label_tag }} {{ form.password2 }}
            <div class="d-flex justify-content-between align-items-center mt-4">
              <a href="{% url 'common:login' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>로그인으로 돌아가기
              </a>
              <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" disabled>
                <i class="fas fa-user-plus me-1"></i>회원가입 완료
              </button>
            </div>
          </form>
        </div>
      </div>
      <div class="text-center mt-4">
        <p class="text-muted small">
          <i class="fas fa-shield-alt me-1"></i>
          테크창은 안전한 이메일 인증을 통해 계정을 보호합니다
        </p>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const emailEl   = document.getElementById('{{ form.email.id_for_label }}');
  const sendBtn   = document.getElementById('sendCodeBtn');
  const codeSec   = document.getElementById('codeSection');
  const codeInput = document.getElementById('verificationCode');
  const verifyBtn = document.getElementById('verifyCodeBtn');
  const statusDiv = document.getElementById('verificationStatus');
  const submitBtn = document.getElementById('submitBtn');

  function getCSRF() {
    const match = document.cookie.match(/csrftoken=([^;]+)/);
    return match && match[1];
  }

  sendBtn.addEventListener('click', () => {
    const email = emailEl.value.trim();
    if (!email) return alert('이메일을 입력해주세요.');
    sendBtn.disabled = true;
    fetch("{% url 'common:send_verification_email' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRF()
      },
      body: JSON.stringify({ email })
    })
    .then(r => r.json())
    .then(data => {
      alert(data.message);
      if (data.success) codeSec.style.display = 'block';
      else sendBtn.disabled = false;
    })
    .catch(() => {
      alert('서버 오류');
      sendBtn.disabled = false;
    });
  });

  verifyBtn.addEventListener('click', () => {
    const email = emailEl.value.trim();
    const code  = codeInput.value.trim();
    if (!email || !code) return alert('이메일과 코드 모두 입력해주세요.');
    verifyBtn.disabled = true;
    fetch("{% url 'common:verify_email_code' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRF()
      },
      body: JSON.stringify({ email, code })
    })
    .then(r => r.json())
    .then(data => {
      statusDiv.textContent = data.message;
      if (data.success) submitBtn.disabled = false;
      else verifyBtn.disabled = false;
    })
    .catch(() => {
      alert('서버 오류');
      verifyBtn.disabled = false;
    });
  });
});
</script>
{% endblock %}
